suite: test redis secret connection details
templates:
  - secret.yaml
tests:
  - it: should render secret with all connection fields when auth is enabled
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - isNotEmpty:
          path: data["redis-password"]
      - isNotEmpty:
          path: data.host
      - isNotEmpty:
          path: data.port
      - isNotEmpty:
          path: data.username
      - isNotEmpty:
          path: data.uri

  - it: should set correct host, port and username
    set:
      auth.password: "testpassword"
    asserts:
      - equal:
          path: data.host
          value: "UkVMRUFTRS1OQU1FLXJlZGlzLk5BTUVTUEFDRS5zdmM="
      - equal:
          path: data.port
          value: "NjM3OQ=="
      - equal:
          path: data.username
          value: "ZGVmYXVsdA=="

  - it: should use redis scheme in uri by default
    set:
      auth.password: "testpassword"
    asserts:
      - equal:
          path: data.uri
          value: "cmVkaXM6Ly9kZWZhdWx0OnRlc3RwYXNzd29yZEBSRUxFQVNFLU5BTUUtcmVkaXMuTkFNRVNQQUNFLnN2Yzo2Mzc5"

  - it: should use custom service port in connection details
    set:
      auth.password: "testpassword"
      service.port: 6380
    asserts:
      - equal:
          path: data.port
          value: "NjM4MA=="

  - it: should not render secret when auth is disabled
    set:
      auth.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render secret when existingSecret is set
    set:
      auth.existingSecret: my-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render secret when acl is enabled
    set:
      auth.acl.enabled: true
      auth.acl.existingSecret: my-acl-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should use rediss scheme and tls port when tls is enabled
    set:
      auth.password: "testpassword"
      tls.enabled: true
      tls.existingSecret: my-tls-secret
    asserts:
      - equal:
          path: data.port
          value: "NjM4MA=="
      - equal:
          path: data.uri
          value: "cmVkaXNzOi8vZGVmYXVsdDp0ZXN0cGFzc3dvcmRAUkVMRUFTRS1OQU1FLXJlZGlzLk5BTUVTUEFDRS5zdmM6NjM4MA=="
